---
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component
# These patches will define the overlay for sync-waves within
# GitOps-orchestrated RHOSO deployment.
patches:
  # --- Wave -30: Create general Namespaces (default for all namespaces) ---
  - target:
      kind: Namespace
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/managed-by: openshift-gitops
          argocd.argoproj.io/sync-wave: "-30"
  # --- Wave -29: Create openstack namespace after openstack-operators namespace ---
  - target:
      kind: Namespace
      name: openstack
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/managed-by: openshift-gitops
          argocd.argoproj.io/sync-wave: "-29"
  # --- Wave -31: Create openstack-operators namespace first (deleted last) ---
  - target:
      kind: Namespace
      name: openstack-operators
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/managed-by: openshift-gitops
          argocd.argoproj.io/sync-wave: "-31"
  # --- Wave -20: Set up OperatorGroup and CatalogSource for Operator deployments ---
  - target:
      kind: OperatorGroup
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-20"
  - target:
      kind: CatalogSource
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-20"
  # --- Wave -10: Subscribe to Operators and Advanced Cluster Manager setup ---
  - target:
      kind: Subscription
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-10"
  - target:
      group: operator.open-cluster-management.io
      version: v1
      kind: MultiClusterHub
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "-10"
  # --- Wave 0 (default): Base infrastructure and OpenStack operator initialization ---
  - target:
      kind: LVMCluster
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  - target:
      kind: ArgoCD
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  - target:
      kind: NMState
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "0"
  - target:
      group: operator.openstack.org
      version: v1beta1
      kind: OpenStack
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "-5"
  # --- Wave 1: MetalLB, network policies, and Vault connection ---
  - target:
      kind: MetalLB
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "1"
  - target:
      group: nmstate.io
      version: v1
      kind: NodeNetworkConfigurationPolicy
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "1"
  - target:
      group: secrets.hashicorp.com
      version: v1beta1
      kind: VaultConnection
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "1"
  # --- Wave 2: Network attachment definitions and Vault authentication ---
  - target:
      group: k8s.cni.cncf.io
      version: v1
      kind: NetworkAttachmentDefinition
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "2"
  - target:
      group: secrets.hashicorp.com
      version: v1beta1
      kind: VaultAuth
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "2"
  # --- Wave 3: MetalLB IP pools and Vault secrets ---
  - target:
      group: metallb.io
      kind: IPAddressPool
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "3"
  - target:
      group: secrets.hashicorp.com
      version: v1beta1
      kind: VaultStaticSecret
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "3"
  # --- Wave 4: MetalLB L2 advertisement ---
  - target:
      group: metallb.io
      kind: L2Advertisement
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "4"
  # --- Wave 5: OpenStack network configuration ---
  - target:
      group: network.openstack.org
      version: v1beta1
      kind: NetConfig
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "5"
  # --- Wave 10: OpenStack ControlPlane deployment ---
  - target:
      group: core.openstack.org
      version: v1beta1
      kind: OpenStackControlPlane
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "10"
  # --- Wave 15: OpenStack DataPlane NodeSet ---
  - target:
      group: dataplane.openstack.org
      version: v1beta1
      kind: OpenStackDataPlaneNodeSet
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "15"
  # --- Wave 20: OpenStack DataPlane Deployment (deployed last, deleted first) ---
  - target:
      group: dataplane.openstack.org
      version: v1beta1
      kind: OpenStackDataPlaneDeployment
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
          argocd.argoproj.io/sync-wave: "20"
